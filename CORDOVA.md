# Apache Cordova Setup for GCashMall

This document describes how to build and deploy the GCashMall app for Android using Apache Cordova.

## Prerequisites

1. **Node.js** - Install Node.js (v16 or later)
2. **Android Studio** - Install Android Studio with Android SDK
3. **Java JDK** - Install JDK 17 (required for Cordova Android 12 with Gradle 7.6 and AGP 7.4.2)
   
   **Important**: JDK 21+ causes build errors:
   - D8 dexing NullPointerException during Gradle build
   - `javax.xml.bind.annotation.XmlSchema` ClassNotFoundException in apkanalyzer
   
   You **must** set JAVA_HOME to JDK 17 in your shell profile:
   
   ```bash
   # Install JDK 17 if not already installed
   brew install openjdk@17
   
   # Add these lines to your ~/.zshrc (or ~/.bash_profile for bash):
   export JAVA_HOME=/opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk/Contents/Home
   export PATH="$JAVA_HOME/bin:$PATH"
   
   # Then reload your shell:
   source ~/.zshrc
   ```
   
   Verify the correct version is active:
   ```bash
   java -version  # Should show openjdk 17.x.x
   ```
4. **Android SDK** - Ensure the following are installed via Android Studio SDK Manager:
   - Android SDK Platform 33 (Android 13)
   - Android SDK Build-Tools 33.0.2
   - Android Emulator
   - Android SDK Platform-Tools

5. Set environment variables:
   ```bash
   export ANDROID_HOME=$HOME/Library/Android/sdk
   export PATH=$PATH:$ANDROID_HOME/emulator
   export PATH=$PATH:$ANDROID_HOME/platform-tools
   ```

## Setup

1. Install project dependencies:
   ```bash
   npm install
   ```

2. Add the Android platform:
   ```bash
   npx cordova platform add android
   ```

## Build Commands

### Development Build
Build and run on a connected Android device or emulator:
```bash
npm run cordova:run
```

### Emulator Build
Build and run on the Android emulator:
```bash
npm run cordova:emulate
```

### Release Build
Build a release APK:
```bash
npm run cordova:build:release
```

The release APK will be located at:
`platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk`

## Signing the Release APK

1. Generate a keystore (one-time):
   ```bash
   keytool -genkey -v -keystore gcashmall-release.keystore -alias gcashmall -keyalg RSA -keysize 2048 -validity 10000
   ```

2. Sign the APK:
   ```bash
   jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore gcashmall-release.keystore platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk gcashmall
   ```

3. Optimize the APK:
   ```bash
   zipalign -v 4 platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk GCashMall.apk
   ```

## Adding Cordova Plugins

To add Cordova plugins (e.g., for camera, storage, etc.):

```bash
npx cordova plugin add cordova-plugin-camera
npx cordova plugin add cordova-plugin-file
npx cordova plugin add cordova-plugin-statusbar
npx cordova plugin add cordova-plugin-splashscreen
```

## Project Structure

- `config.xml` - Cordova configuration file
- `www/` - Built web assets (generated by Vite)
- `platforms/` - Platform-specific code (generated by Cordova)
- `plugins/` - Installed Cordova plugins
- `res/android/` - Android icons (splash screens use AndroidWindowSplashScreenAnimatedIcon preference)

## Splash Screen Configuration

Android 12+ uses the new Splash Screen API. The splash screen is configured via preferences in `config.xml`:

```xml
<preference name="AndroidWindowSplashScreenAnimatedIcon" value="res/android/xhdpi.png" />
<preference name="AndroidWindowSplashScreenBackground" value="#FFFFFF" />
```

The animated icon should be a 288x288dp drawable (1152x1152 pixels for xxxhdpi).

## Troubleshooting

### Build fails with SDK not found
Ensure `ANDROID_HOME` environment variable is set correctly.

### Emulator not starting
Make sure you have created an Android Virtual Device (AVD) in Android Studio.

### App crashes on launch
Check the console logs using:
```bash
adb logcat | grep -i "chromium\|SystemWebView"
```

### D8 dexing NullPointerException (Cannot invoke "String.length()")
This error occurs when using JDK 21 or higher with Cordova Android 12 / AGP 7.4.2:

```
ERROR: D8: java.lang.NullPointerException: Cannot invoke "String.length()" because "<parameter1>" is null
```

**Solution**: Configure Gradle to use JDK 17.

**Option 1: gradle.properties (Recommended)**

This project has [`platforms/android/gradle.properties`](platforms/android/gradle.properties) configured with:
```properties
org.gradle.java.home=/opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk/Contents/Home
```

If the file is missing (e.g., after removing and re-adding the platform), recreate it with the JDK 17 path.

**Option 2: Environment Variable**

Alternatively, set JAVA_HOME before building:
```bash
export JAVA_HOME=/opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk/Contents/Home
```

**After configuring JDK 17, clean and rebuild:**
```bash
rm -rf platforms/android/.gradle platforms/android/CordovaLib/build platforms/android/app/build
npx cordova build android
```

### javax.xml.bind.annotation.XmlSchema ClassNotFoundException

This error occurs when Android SDK tools (apkanalyzer, avdmanager) run with JDK 11+:

```
Exception in thread "main" java.lang.NoClassDefFoundError: javax/xml/bind/annotation/XmlSchema
```

**Solution**: This project includes an automatic patch via `postinstall` script ([`scripts/cordova-android-jdk-fix.js`](scripts/cordova-android-jdk-fix.js)) that forces these tools to use JDK 17.

The patch is applied automatically after `npm install`. If you still encounter the error:

1. Verify JDK 17 is installed:
   ```bash
   brew install openjdk@17
   ls /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk/Contents/Home
   ```

2. Re-run the patch manually:
   ```bash
   node scripts/cordova-android-jdk-fix.js
   ```

3. Run the Cordova command again:
   ```bash
   npm run cordova:emulate
   ```
